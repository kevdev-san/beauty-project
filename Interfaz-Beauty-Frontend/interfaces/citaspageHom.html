<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda tu cita - Keracao Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2AA6B6;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #999;
            font-size: 14px;
        }

        /* Stepper */
        .stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            background: linear-gradient(90deg, #1A8A97 0%, #2AA6B6 100%);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2AA6B6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }

        .step.inactive {
            background: #1A6A77;
        }

        .step-line {
            flex: 1;
            height: 3px;
            background: #1A6A77;
            position: relative;
            z-index: 1;
        }

        .step-line.active {
            background: #2AA6B6;
        }

        /* Grid de secciones */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-card {
            background: #000;
            border: 2px solid #2AA6B6;
            border-radius: 20px;
            padding: 30px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2AA6B6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 16px;
            color: white;
        }

        /* Servicios y Profesionales */
        .service-item, .professional-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #000;
        }

        .service-item:hover, .professional-item:hover {
            border-color: #2AA6B6;
            background: #0A1A1D;
        }

        .service-item.selected, .professional-item.selected {
            border-color: #2AA6B6;
            background: #0A1A1D;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .service-radio, .professional-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .service-item.selected .service-radio,
        .professional-item.selected .professional-radio {
            border-color: #2AA6B6;
            background: radial-gradient(circle, #2AA6B6 0%, #2AA6B6 40%, transparent 40%);
        }

        .service-details h4, .professional-info h4 {
            font-size: 14px;
            color: white;
            margin-bottom: 3px;
        }

        .service-details p, .professional-info p {
            font-size: 12px;
            color: #888;
        }

        .service-price {
            background: #2AA6B6;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .professional-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            overflow: hidden;
            flex-shrink: 0;
        }

        .professional-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Calendario */
        .calendar-wrapper {
            background: white;
            border-radius: 15px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            font-size: 16px;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            background: white;
            border: 1px solid #E0E0E0;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }

        .calendar-nav button:hover {
            border-color: #2AA6B6;
            color: #2AA6B6;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            color: #333;
        }

        .calendar-day:hover:not(.disabled):not(.empty) {
            border-color: #2AA6B6;
            background: #E6F7F9;
        }

        .calendar-day.selected {
            background: #333;
            color: white;
            font-weight: bold;
        }

        .calendar-day.disabled {
            color: #CCC;
            cursor: not-allowed;
        }

        .calendar-day.disabled:hover {
            border-color: transparent;
            background: transparent;
        }

        .calendar-day.empty {
            cursor: default;
        }

        /* Horarios */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .time-slot {
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            color: white;
            transition: all 0.2s ease;
            background: #000;
        }

        .time-slot:hover:not(.disabled) {
            border-color: #2AA6B6;
            background: #0A1A1D;
        }

        .time-slot.selected {
            background: #2AA6B6;
            color: white;
            border-color: #2AA6B6;
            font-weight: bold;
        }

        .time-slot.disabled {
            color: #555;
            cursor: not-allowed;
            background: #111;
            border-color: #222;
        }

        .time-slot.disabled:hover {
            border-color: #222;
            background: #111;
        }

        .time-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Botón confirmar */
        .confirm-button {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 15px;
            background: #2AA6B6;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .confirm-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(42, 166, 182, 0.4);
            background: #238A96;
        }

        .confirm-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .error-message {
            background: #3d1a1a;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #ff6b6b;
        }

        .success-message {
            background: #1a3d1a;
            color: #6bff6b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #6bff6b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }

            .stepper {
                gap: 0;
                padding: 8px 15px;
            }

            .step {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .time-slots {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Agenda tu cita</h1>
            <p>Selecciona el servicio, profesional y horario que prefieras</p>
        </div>

        <!-- Stepper -->
        <div class="stepper">
            <div class="step" id="step-1">1</div>
            <div class="step-line" id="line-1"></div>
            <div class="step inactive" id="step-2">2</div>
            <div class="step-line" id="line-2"></div>
            <div class="step inactive" id="step-3">3</div>
            <div class="step-line" id="line-3"></div>
            <div class="step inactive" id="step-4">4</div>
        </div>

        <div id="message-container"></div>

        <!-- Secciones -->
        <div class="sections-grid">
            <!-- Servicios -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-number">1</div>
                    <div class="section-title">Selecciona un servicio</div>
                </div>
                <div id="services-container" class="loading">Cargando servicios...</div>
            </div>

            <!-- Profesionales -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-number">2</div>
                    <div class="section-title">Selecciona quien deseas que te atienda</div>
                </div>
                <div id="professionals-container" class="loading">Cargando profesionales...</div>
            </div>

            <!-- Calendario -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-number">3</div>
                    <div class="section-title">Selecciona la fecha</div>
                </div>

                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <h3 id="calendar-month">Cargando...</h3>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()">‹</button>
                            <button onclick="nextMonth()">›</button>
                        </div>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday">Do</div>
                        <div class="weekday">Lu</div>
                        <div class="weekday">Ma</div>
                        <div class="weekday">Mi</div>
                        <div class="weekday">Ju</div>
                        <div class="weekday">Vi</div>
                        <div class="weekday">Sa</div>
                    </div>

                    <div class="calendar-days" id="calendar-days"></div>
                </div>
            </div>

            <!-- Horarios -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-number">4</div>
                    <div class="section-title">Elige el horario</div>
                </div>

                <div class="time-info" id="time-info">Selecciona una fecha primero</div>
                <div class="time-slots" id="time-slots"></div>
            </div>
        </div>

        <button class="confirm-button" id="confirm-button" onclick="confirmAppointment()" disabled>
            Confirmar cita
        </button>
    </div>

    <script>
        // Configuración de la API
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        
        // Estado de la aplicación
        let appState = {
            userId: null,
            selectedServices: [],
            selectedProfessional: null,
            selectedDate: null,
            selectedTime: null,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            services: [],
            professionals: [],
            availableTimes: []
        };

        // Función para obtener headers con token
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-Requested-With': 'XMLHttpRequest'
            };
        }

        // Verificar autenticación al cargar la página
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    sessionStorage.setItem('redirect_after_login', 'citaspage.html');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/me`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.setItem('redirect_after_login', 'citaspage.html');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al verificar autenticación');
                }

                const userData = await response.json();
                appState.userId = userData.id;
                
                initializeApp();
            } catch (error) {
                console.error('Error de autenticación:', error);
                localStorage.removeItem('token');
                sessionStorage.setItem('redirect_after_login', 'citaspage.html');
                window.location.href = 'login.html';
            }
        });

        // Inicializar la aplicación
        async function initializeApp() {
            try {
                await loadServices();
                await loadProfessionals();
                renderCalendar();
                updateSteppers();
            } catch (error) {
                console.error('Error al inicializar:', error);
                showMessage('Error al cargar los datos. Por favor, recarga la página.', 'error');
            }
        }

        // Cargar servicios desde la API
        async function loadServices() {
            try {
                const response = await fetch(`${API_BASE_URL}/servicios`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar servicios');

                const data = await response.json();
                appState.services = Array.isArray(data) ? data : (data.data || []);
                renderServices();
            } catch (error) {
                console.error('Error:', error);
                showMessage('No se pudieron cargar los servicios', 'error');
            }
        }

        // Renderizar servicios
        function renderServices() {
            const container = document.getElementById('services-container');
            container.className = '';
            
            if (appState.services.length === 0) {
                container.innerHTML = '<p style="color: #888;">No hay servicios disponibles</p>';
                return;
            }

            container.innerHTML = appState.services.map(service => `
                <div class="service-item" onclick="selectService(${service.id_servicio})">
                    <div class="service-info">
                        <div class="service-radio"></div>
                        <div class="service-details">
                            <h4>${service.nombre}</h4>
                            <p>${service.duracion || 'Duración variable'}</p>
                        </div>
                    </div>
                    <div class="service-price">$${service.precio}</div>
                </div>
            `).join('');
        }

        // Cargar profesionales desde la API
        async function loadProfessionals() {
            try {
                const response = await fetch(`${API_BASE_URL}/empleados`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar profesionales');

                const data = await response.json();
                appState.professionals = Array.isArray(data) ? data : (data.data || []);
                renderProfessionals();
            } catch (error) {
                console.error('Error:', error);
                showMessage('No se pudieron cargar los profesionales', 'error');
            }
        }

        // Renderizar profesionales
        function renderProfessionals() {
            const container = document.getElementById('professionals-container');
            container.className = '';
            
            if (appState.professionals.length === 0) {
                container.innerHTML = '<p style="color: #888;">No hay profesionales disponibles</p>';
                return;
            }

            container.innerHTML = appState.professionals.map(prof => `
                <div class="professional-item" onclick="selectProfessional(${prof.id_empleado})">
                    <div class="professional-radio"></div>
                    <div class="professional-avatar">
                        <img src="${prof.foto || '../img/image 10.png'}" alt="${prof.nombre}">
                    </div>
                    <div class="professional-info">
                        <h4>${prof.nombre}</h4>
                        <p>${prof.especialidad || 'Profesional'}</p>
                    </div>
                </div>
            `).join('');
        }

        // Seleccionar servicio
        function selectService(serviceId) {
            appState.selectedServices = [serviceId];
            
            document.querySelectorAll('.service-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateSteppers();
            checkFormComplete();
        }

        // Seleccionar profesional
        function selectProfessional(professionalId) {
            appState.selectedProfessional = professionalId;
            document.querySelectorAll('.professional-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            updateSteppers();
            
            if (appState.selectedDate) {
                loadAvailableTimes();
            }
            
            checkFormComplete();
        }

        // Renderizar calendario
        function renderCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('calendar-month').textContent = 
                `${monthNames[appState.currentMonth]} ${appState.currentYear}`;

            const firstDay = new Date(appState.currentYear, appState.currentMonth, 1);
            const lastDay = new Date(appState.currentYear, appState.currentMonth + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';

            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                daysContainer.appendChild(emptyDay);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayDate = new Date(appState.currentYear, appState.currentMonth, day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;

                if (dayDate < today) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.onclick = () => selectDay(dayDate);
                }

                if (appState.selectedDate && 
                    dayDate.toDateString() === appState.selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }

                daysContainer.appendChild(dayElement);
            }
        }

        // Seleccionar día
        function selectDay(date) {
            appState.selectedDate = date;
            appState.selectedTime = null;
            renderCalendar();
            updateSteppers();
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('time-info').textContent = 
                `Horarios disponibles para ${date.toLocaleDateString('es-ES', options)}`;
            
            loadAvailableTimes();
            checkFormComplete();
        }

        // Cargar horarios disponibles
        async function loadAvailableTimes() {
            if (!appState.selectedDate || !appState.selectedProfessional) {
                document.getElementById('time-slots').innerHTML = '';
                return;
            }

            const formattedDate = appState.selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/horarios-disponibles?fecha=${formattedDate}&id_empleado=${appState.selectedProfessional}`,
                    { headers: getAuthHeaders() }
                );

                if (response.ok) {
                    const data = await response.json();
                    appState.availableTimes = Array.isArray(data) ? data : (data.data || data.horarios || []);
                    renderTimeSlots();
                } else {
                    generateDefaultTimeSlots();
                }
            } catch (error) {
                console.error('Error:', error);
                generateDefaultTimeSlots();
            }
        }

        // Generar horarios por defecto
        function generateDefaultTimeSlots() {
            const times = [];
            for (let hour = 9; hour <= 18; hour++) {
                times.push({ hora: `${hour.toString().padStart(2, '0')}:00`, disponible: true });
                if (hour < 18) {
                    times.push({ hora: `${hour.toString().padStart(2, '0')}:30`, disponible: Math.random() > 0.3 });
                }
            }
            appState.availableTimes = times;
            renderTimeSlots();
        }

        // Renderizar horarios
        function renderTimeSlots() {
            const container = document.getElementById('time-slots');
            container.innerHTML = appState.availableTimes.map(time => `
                <div class="time-slot ${!time.disponible ? 'disabled' : ''}" 
                     ${time.disponible ? `onclick="selectTime('${time.hora}')"` : ''}>
                    ${time.hora}
                </div>
            `).join('');
        }

        // Seleccionar hora
        function selectTime(time) {
            appState.selectedTime = time;
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            updateSteppers();
            checkFormComplete();
        }

        // Mes anterior
        function previousMonth() {
            const today = new Date();
            const newDate = new Date(appState.currentYear, appState.currentMonth - 1);
            
            if (newDate < new Date(today.getFullYear(), today.getMonth())) {
                return;
            }
            
            if (appState.currentMonth === 0) {
                appState.currentMonth = 11;
                appState.currentYear--;
            } else {
                appState.currentMonth--;
            }
            renderCalendar();
        }

        // Mes siguiente
        function nextMonth() {
            if (appState.currentMonth === 11) {
                appState.currentMonth = 0;
                appState.currentYear++;
            } else {
                appState.currentMonth++;
            }
            renderCalendar();
        }

        // Actualizar indicadores de pasos
        function updateSteppers() {
            const steps = [
                appState.selectedServices.length > 0,
                appState.selectedProfessional !== null,
                appState.selectedDate !== null,
                appState.selectedTime !== null
            ];

            steps.forEach((completed, index) => {
                const step = document.getElementById(`step-${index + 1}`);
                const line = document.getElementById(`line-${index + 1}`);
                
                if (completed) {
                    step.classList.remove('inactive');
                    if (line && completed) line.classList.add('active');
                } else {
                    step.classList.add('inactive');
                    if (line) line.classList.remove('active');
                }
            });
        }

        // Verificar si el formulario está completo
        function checkFormComplete() {
            const button = document.getElementById('confirm-button');
            const isComplete = appState.selectedServices.length > 0 && 
                             appState.selectedProfessional && 
                             appState.selectedDate && 
                             appState.selectedTime;
            
            button.disabled = !isComplete;
        }

        // Confirmar cita
        async function confirmAppointment() {
            if (appState.selectedServices.length === 0 || !appState.selectedProfessional || 
                !appState.selectedDate || !appState.selectedTime) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }

            const button = document.getElementById('confirm-button');
            button.disabled = true;
            button.textContent = 'Procesando...';

            try {
                const response = await fetch(`${API_BASE_URL}/citas`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        id_cliente: appState.userId,
                        id_empleado: appState.selectedProfessional,
                        fecha: appState.selectedDate.toISOString().split('T')[0],
                        hora: appState.selectedTime,
                        servicios: appState.selectedServices
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Error al crear la cita');
                }

                showMessage('¡Cita agendada exitosamente!', 'success');
                
                if (data.cita) {
                    sessionStorage.setItem('last_appointment', JSON.stringify(data.cita));
                }
                
                setTimeout(() => {
                    window.location.href = 'ConfirmacioncitaHom.html';
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                showMessage(error.message || 'Hubo un error al agendar la cita. Por favor intenta de nuevo.', 'error');
                button.disabled = false;
                button.textContent = 'Confirmar cita';
            }
        }

        // Mostrar mensaje
        function showMessage(message, type = 'error') {
            const container = document.getElementById('message-container');
            const className = type === 'success' ? 'success-message' : 'error-message';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>